---
// Search bar component for site-wide search functionality - Adapted for Coulsy Joinery
---

<div class="relative" id="search-container">
  <div class="relative">
    <input
      type="text"
      placeholder="Search joinery services..."
      class="w-full px-4 py-3 pl-12 pr-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-600 focus:border-transparent bg-white text-gray-900 dark:bg-gray-800 dark:border-gray-600 dark:text-white shadow-sm"
      id="search-input"
      autocomplete="off"
    />
    <div
      class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
    >
      <svg
        class="h-5 w-5 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
    <button
      type="button"
      class="absolute inset-y-0 right-0 pr-3 flex items-center"
      id="clear-search"
      style="display: none;"
    >
      <svg
        class="h-5 w-5 text-gray-400 hover:text-gray-600"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Search Results Dropdown -->
  <div
    class="absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg max-h-96 overflow-y-auto"
    id="search-results"
    style="display: none;"
  >
    <div class="p-4">
      <div id="search-results-content">
        <!-- Results will be populated here -->
      </div>
    </div>
  </div>
</div>

<script>
  class SiteSearch {
    private searchInput: HTMLInputElement | null;
    private searchResults: HTMLElement | null;
    private clearButton: HTMLElement | null;
    private resultsContent: HTMLElement | null;
    private searchTimeout: NodeJS.Timeout | null;
    private isSearching: boolean;
    private searchData: any;

    constructor() {
      this.searchInput = document.getElementById(
        "search-input"
      ) as HTMLInputElement;
      this.searchResults = document.getElementById("search-results");
      this.clearButton = document.getElementById("clear-search");
      this.resultsContent = document.getElementById("search-results-content");
      this.searchTimeout = null;
      this.isSearching = false;
      this.searchData = {};

      this.init();
    }

    init() {
      this.setupEventListeners();
      this.loadSearchData();
    }

    setupEventListeners() {
      this.searchInput?.addEventListener("input", (e) => {
        this.handleSearchInput((e.target as HTMLInputElement).value);
      });

      this.searchInput?.addEventListener("focus", () => {
        if (this.searchInput?.value.trim()) {
          this.showResults();
        }
      });

      this.clearButton?.addEventListener("click", () => {
        this.clearSearch();
      });

      document.addEventListener("click", (e) => {
        if (!(e.target as Element).closest("#search-container")) {
          this.hideResults();
        }
      });

      this.searchInput?.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          this.hideResults();
        }
      });
    }

    async loadSearchData() {
      try {
        // Load services data
        const servicesResponse = await fetch("/api/services");
        if (servicesResponse.ok) {
          this.searchData.services = await servicesResponse.json();
        } else {
          // Fallback data if API fails
          this.searchData.services = [
            {
              title: "Kitchen Installation",
              url: "/joinery-services/kitchen-installers",
              type: "service",
            },
            {
              title: "Bespoke Joinery",
              url: "/joinery-services/bespoke-joinery",
              type: "service",
            },
            {
              title: "Garden Offices",
              url: "/joinery-services/garden-offices",
              type: "service",
            },
            {
              title: "Heritage Restoration",
              url: "/joinery-services/heritage-restoration-joinery",
              type: "service",
            },
            {
              title: "General Joinery",
              url: "/joinery-services/general-joinery",
              type: "service",
            },
            {
              title: "Door Hanging",
              url: "/joinery-services/door-hanging",
              type: "service",
            },
            {
              title: "Stud Walls",
              url: "/joinery-services/stud-wall-partitioning",
              type: "service",
            },
            {
              title: "Cut Roofs",
              url: "/joinery-services/traditional-cut-roofs",
              type: "service",
            },
            {
              title: "Truss Roofs",
              url: "/joinery-services/truss-roof-installers",
              type: "service",
            },
            {
              title: "Steel Fire Exit Doors",
              url: "/joinery-services/steel-fire-exit-doors-installers",
              type: "service",
            },
            {
              title: "Accessible Kitchens",
              url: "/joinery-services/accessible-kitchen-installers",
              type: "service",
            },
            {
              title: "Joinery Subcontractors",
              url: "/joinery-services/joinery-subcontractors",
              type: "service",
            },
          ];
        }

        // Load locations data
        const locationsResponse = await fetch("/api/locations");
        if (locationsResponse.ok) {
          this.searchData.locations = await locationsResponse.json();
        } else {
          // Fallback locations if API fails
          this.searchData.locations = [
            "York",
            "Harrogate",
            "Leeds",
            "Wetherby",
            "Knaresborough",
            "Otley",
            "Ilkley",
            "Pontefract",
            "Wakefield",
            "Selby",
            "Malton",
            "Thirsk",
            "Ripon",
            "Boroughbridge",
            "Tadcaster",
            "Garforth",
            "Horsforth",
            "Castleford",
            "Rothwell",
            "Normanton",
          ];
        }
      } catch (error) {
        console.error("Error loading search data:", error);
        // Use fallback data
        this.searchData = {
          services: [
            {
              title: "Kitchen Installation",
              url: "/joinery-services/kitchen-installers",
              type: "service",
            },
            {
              title: "Bespoke Joinery",
              url: "/joinery-services/bespoke-joinery",
              type: "service",
            },
          ],
          locations: ["York", "Harrogate", "Leeds"],
        };
      }
    }

    handleSearchInput(query: string) {
      const trimmedQuery = query.trim();

      if (this.clearButton) {
        this.clearButton.style.display = trimmedQuery ? "flex" : "none";
      }

      if (this.searchTimeout) {
        clearTimeout(this.searchTimeout);
      }

      if (trimmedQuery.length < 2) {
        this.hideResults();
        return;
      }

      this.searchTimeout = setTimeout(() => {
        this.performSearch(trimmedQuery);
      }, 300);
    }

    async performSearch(query: string) {
      if (this.isSearching) return;

      this.isSearching = true;
      const results = this.searchLocal(query);
      this.displayResults(results, query);
      this.isSearching = false;
    }

    searchLocal(query: string) {
      const lowerQuery = query.toLowerCase();
      const results: any[] = [];

      // Search services
      this.searchData.services.forEach((service: any) => {
        if (service.title.toLowerCase().includes(lowerQuery)) {
          results.push({
            ...service,
            relevance: this.calculateRelevance(service.title, query),
          });
        }
      });

      // Search locations
      this.searchData.locations.forEach((location: string) => {
        if (location.toLowerCase().includes(lowerQuery)) {
          results.push({
            title: `Joinery Services in ${location}`,
            url: `/joinery-services/${location.toLowerCase().replace(/\s+/g, "-")}-joinery`,
            type: "location",
            relevance: this.calculateRelevance(location, query),
          });
        }
      });

      return results.sort((a, b) => b.relevance - a.relevance).slice(0, 8);
    }

    calculateRelevance(text: string, query: string) {
      const lowerText = text.toLowerCase();
      const lowerQuery = query.toLowerCase();

      // Exact match gets highest relevance
      if (lowerText === lowerQuery) return 100;

      // Starts with query gets high relevance
      if (lowerText.startsWith(lowerQuery)) return 90;

      // Contains query gets medium relevance
      if (lowerText.includes(lowerQuery)) return 70;

      // Partial word match gets lower relevance
      const words = lowerText.split(/\s+/);
      const queryWords = lowerQuery.split(/\s+/);
      let partialMatches = 0;

      for (const word of words) {
        for (const queryWord of queryWords) {
          if (word.includes(queryWord) || queryWord.includes(word)) {
            partialMatches++;
          }
        }
      }

      return partialMatches * 20;
    }

    displayResults(results: any[], query: string) {
      if (!this.resultsContent) return;

      if (results.length === 0) {
        this.resultsContent.innerHTML = `
          <div class="p-4 text-center text-gray-500">
            <p>No results found for "${query}"</p>
            <p class="text-sm mt-1">Try different keywords or browse our services</p>
          </div>
        `;
      } else {
        const resultsHtml = results
          .map(
            (result: any) => `
            <a href="${result.url}" class="block p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200">
              <div class="flex items-center">
                <div class="flex-shrink-0 mr-3">
                  <div class="w-8 h-8 bg-brand-100 dark:bg-brand-900 rounded-lg flex items-center justify-center">
                    ${result.type === "service" ? "🔨" : "📍"}
                  </div>
                </div>
                <div class="flex-1">
                  <div class="font-medium text-gray-900 dark:text-white">${result.title}</div>
                  <div class="text-sm text-gray-500 dark:text-gray-400 capitalize">${result.type}</div>
                </div>
                <div class="flex-shrink-0">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </div>
              </div>
            </a>
          `
          )
          .join("");

        this.resultsContent.innerHTML = resultsHtml;
      }

      this.showResults();
    }

    showResults() {
      if (this.searchResults) {
        this.searchResults.style.display = "block";
      }
    }

    hideResults() {
      if (this.searchResults) {
        this.searchResults.style.display = "none";
      }
    }

    clearSearch() {
      if (this.searchInput) {
        this.searchInput.value = "";
        this.hideResults();
        if (this.clearButton) {
          this.clearButton.style.display = "none";
        }
        this.searchInput.focus();
      }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    new SiteSearch();
  });
</script>

<style>
  #search-input {
    color: #111827 !important;
    background-color: #ffffff !important;
  }

  .dark #search-input {
    color: #f9fafb !important;
    background-color: #1f2937 !important;
  }

  #search-input::placeholder {
    color: #6b7280 !important;
  }

  .dark #search-input::placeholder {
    color: #9ca3af !important;
  }
</style>
